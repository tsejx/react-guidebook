## Redux

> Redux is a predictable state container for JavaScript apps
>
> Redux æ˜¯ä¸€ä¸ªå¯é¢„æµ‹çš„ State çŠ¶æ€å®¹å™¨

Redux å‚è€ƒäº† Flux çš„æ¶æ„æ€æƒ³ï¼Œå¯¹ Flux ä¸­å†—ä½™éƒ¨åˆ†ï¼ˆå¦‚ Dispatcherï¼‰è¿›è¡Œç®€åŒ–ï¼ŒåŒæ—¶å°† Elm è¯­è¨€ä¸­å‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³èå…¥å…¶ä¸­ã€‚

[Redux ä¸­æ–‡æ–‡æ¡£](https://github.com/camsong/redux-in-chinese)

### ä¸‰å¤§åŸåˆ™

#### å•ä¸€æ•°æ®æº

**æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€æ•°æ®è¢«å‚¨å­˜åœ¨ä¸€æ£µ Object Tree ä¸­ï¼Œå¹¶ä¸”åªå­˜åœ¨äºå”¯ä¸€ä¸€ä¸ª Store ä¸­ã€‚**

åœ¨ä¼ ç»Ÿçš„ MVC æ¶æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ— æ•°ä¸ª Modelï¼Œè€Œ Model ä¹‹é—´å¯ä»¥äº’ç›¸ç›‘å¬ã€ è§¦å‘äº‹ä»¶ç”šè‡³å¾ªç¯æˆ–åµŒå¥—è§¦å‘äº‹ä»¶ï¼Œè¿™äº›åœ¨ Redux ä¸­éƒ½æ˜¯ä¸å…è®¸çš„ã€‚ 

å› ä¸ºåœ¨ Redux çš„æ€æƒ³é‡Œï¼Œä¸€ä¸ªåº”ç”¨æ°¸è¿œåªæœ‰å”¯ä¸€çš„æ•°æ®æºã€‚æˆ‘ä»¬çš„ç¬¬ä¸€ååº”å¯èƒ½æ˜¯ï¼šå¦‚æœæœ‰ä¸€ä¸ªå¤æ‚åº”ç”¨ï¼Œå¼ºåˆ¶è¦æ±‚å”¯ä¸€çš„æ•°æ®æºå²‚ä¸æ˜¯ä¼šäº§ç”Ÿä¸€ä¸ªç‰¹åˆ«åºå¤§çš„ JavaScript å¯¹è±¡ã€‚ 

å®é™…ä¸Šï¼Œä½¿ç”¨å•ä¸€æ•°æ®æºçš„å¥½å¤„åœ¨äºæ•´ä¸ªåº”ç”¨çŠ¶æ€éƒ½ä¿å­˜åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬éšæ—¶å¯ä»¥æå–å‡ºæ•´ä¸ªåº”ç”¨çš„çŠ¶æ€è¿›è¡ŒæŒä¹…åŒ–ï¼ˆæ¯”å¦‚å®ç°ä¸€ä¸ªé’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„å³æ—¶ä¿å­˜åŠŸèƒ½ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™æ · çš„è®¾è®¡ä¹Ÿä¸ºæœåŠ¡ç«¯æ¸²æŸ“æä¾›äº†å¯èƒ½ã€‚ 

è‡³äºæˆ‘ä»¬æ‹…å¿ƒçš„æ•°æ®æºå¯¹è±¡è¿‡äºåºå¤§çš„é—®é¢˜ï¼Œå¯é€šè¿‡äº†è§£ Redux æä¾›çš„å·¥å…·å‡½æ•° `combineReducers` æ˜¯å¦‚ä½•åŒ–è§£çš„ã€‚ 

> ğŸ“Œ Flux å¯èƒ½æœ‰å¤šä¸ª Storeï¼ˆåŒºåˆ«äº Flux çš„ Storeï¼ŒRedux çš„ State ä¸ä¼šå­˜æ”¾é€»è¾‘ï¼Œæ“ä½œæ•°æ®åœ¨ Reducer ä¸­å¤„ç†ã€‚ï¼‰

#### çŠ¶æ€æ˜¯åªè¯»çš„

**åªèƒ½é€šè¿‡è§¦å‘äº‹ä»¶ï¼ˆä¹Ÿå°±æ˜¯è§¦å‘ Actionï¼‰æ¥äº§ç”Ÿæ–°çš„çŠ¶æ€æ•°æ®ï¼ŒAction æ˜¯ä¸€ä¸ªç”¨äºæè¿°å·²å‘ç”Ÿäº‹ä»¶çš„æ™®é€šå¯¹è±¡ã€‚**

è¿™ä¸€ç‚¹å’Œ Flux çš„æ€æƒ³ä¸è°‹è€Œåˆï¼Œä¸åŒçš„æ˜¯åœ¨ Flux ä¸­ï¼Œå› ä¸º Store æ²¡æœ‰ `setter` è€Œé™åˆ¶äº†æˆ‘ä»¬ç›´æ¥ä¿®æ”¹åº”ç”¨çŠ¶æ€çš„èƒ½åŠ›ï¼Œè€Œåœ¨ Redux ä¸­ï¼Œè¿™æ ·çš„é™åˆ¶è¢«æ‰§è¡Œå¾—æ›´åŠ å½»åº•ï¼Œå› ä¸ºæˆ‘ä»¬å‹æ ¹æ²¡æœ‰ Storeã€‚

åœ¨ Redux ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šè‡ªå·±ç”¨ä»£ç æ¥å®šä¹‰ä¸€ä¸ª Storeã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Reducerï¼Œ å®ƒçš„åŠŸèƒ½æ˜¯æ ¹æ®å½“å‰è§¦å‘çš„ Action å¯¹å½“å‰åº”ç”¨çš„ State è¿›è¡Œè¿­ä»£ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç›´æ¥ä¿®æ”¹åº”ç”¨çš„ Stateï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä»½å…¨æ–°çš„çŠ¶æ€ã€‚

Redux æä¾›çš„ `createStore` æ–¹æ³•ä¼šæ ¹æ® Reducer ç”Ÿæˆ Storeã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `store.dispatch` æ–¹æ³•æ¥è¾¾åˆ°ä¿®æ”¹çŠ¶æ€çš„ç›®çš„ã€‚

```js
store.dispatch({
    type: 'COMPLETE_TODO',
    index: 1
})

store.dispatch({
    type: 'SET_VISIBILITY_FILTER',
    filter: 'SHOW_COMPELETED'
})
```

#### ä½¿ç”¨çº¯å‡½æ•°æ‰§è¡Œä¿®æ”¹ 

**åœ¨ Reducer ä¸­æŒ‡å®šçŠ¶æ€æ•°æ®è½¬æ¢çš„é€»è¾‘ã€‚**

**çº¯å‡½æ•°ï¼š**

* ç›¸åŒçš„è¾“å…¥ï¼Œç»“æœå§‹ç»ˆç›¸åŒ
* ä¸å¯¹å¤–éƒ¨ç¯å¢ƒè¿›è¡Œæ“ä½œ

åœ¨ Redux é‡Œï¼Œæˆ‘ä»¬é€šè¿‡å®šä¹‰ Reducer æ¥ç¡®å®šçŠ¶æ€çš„ä¿®æ”¹ï¼Œè€Œæ¯ä¸€ä¸ª Reducer éƒ½æ˜¯çº¯å‡½æ•°ï¼Œè¿™æ„å‘³ç€å®ƒæ²¡æœ‰å‰¯ä½œç”¨ï¼Œå³æ¥å—ä¸€å®šçš„è¾“å…¥ï¼Œå¿…å®šä¼šå¾—åˆ°ä¸€å®šçš„è¾“å‡ºã€‚

è¿™æ ·è®¾è®¡çš„å¥½å¤„ä¸ä»…åœ¨äº Reducer é‡Œå¯¹çŠ¶æ€çš„ä¿®æ”¹å˜å¾—ç®€å•ã€çº¯ç²¹ã€å¯æµ‹è¯•ï¼Œæ›´æœ‰æ„æ€çš„æ˜¯ï¼Œ Redux åˆ©ç”¨æ¯æ¬¡æ–°è¿”å›çš„çŠ¶æ€ç”Ÿæˆé…·ç‚«çš„æ—¶é—´æ—…è¡Œï¼ˆtime travelï¼‰è°ƒè¯•æ–¹å¼ï¼Œè®©è·Ÿè¸ªæ¯ä¸€æ¬¡å› ä¸ºè§¦å‘ Action è€Œæ”¹å˜çŠ¶æ€çš„ç»“æœæˆä¸ºäº†å¯èƒ½ã€‚

```js
function visibilityFilter(state = 'SHOW_ALL', action) {
    switch(action.type) {
            case 'SET_VISIBILITY_FILTER'
                return action.filter
            default 
                return state
    }
}
            
function todos(state = [], action) {
    switch(action.type) {
        case 'ADD_TODO':
            return [
                ...state,
                {
                    text: action.text,
                    completed: false
                }
            ]
        case 'COMPLTE_TODO':
            return state.map((todo, index) => {
                if (index === action.index) {
                    return Object.assign({}, todo, {
                        completed: true
                    })
                }
                return todo
            })
        default:
            return state
    }
}

import { combineReducers, createStore } from 'redux'
let reducer = combineReducers({ visibilityFilter: todos })
let store = createStore(reducer)
```

### å·¥ä½œæµç¨‹

Redux å·¥ä½œæ­¥éª¤ï¼ˆè€ƒè™‘å¼‚æ­¥è°ƒç”¨ï¼‰

1. ç»„ä»¶å¼•å…¥
   * å¼•å…¥ `connect`
   * å¼•å…¥ `action`
   * å¼•å…¥ `reducer`
   * å¼•å…¥ä¸­é—´ä»¶
2. ç»„ä»¶ setState åŠ è½½ï¼šæ„é€ å‡½æ•°ä¸­ï¼ŒåŠ è½½ state çš„åˆå§‹å€¼
3. ç»„ä»¶åŠ¨ä½œ
   * ç»„ä»¶ä¸­äº‹ä»¶ï¼Œè§¦å‘ dispatchï¼Œå°† action å‘å‡ºï¼Œè¿‡æ®µæ—¶é—´å†æ‰§è¡Œ Reducerï¼Œä¿®æ”¹ state çš„å€¼
   * mapDispatchToProps å‡½æ•°è§¦å‘
4. ç»„ä»¶ä¼ é€’ state
   * `reducer(state, action)` è·å¾— action åŠ¨ä½œåçš„ state å€¼
   * é€šè¿‡ mapStateToProps å‡½æ•°ï¼Œç›‘å¬ store å˜åŒ–ï¼Œè¿”å›ä¸€ä¸ªçº¯å¯¹è±¡ä¸æ•°ç»„çš„ props ç»“åˆï¼Œä¼ é€’åˆ° props

### ç¼ºé™·

* ä¸€ä¸ªç»„ä»¶æ‰€éœ€è¦çš„æ•°æ®ï¼Œå¿…é¡»ç”±çˆ¶ç»„ä»¶ä¼ è¿‡æ¥ï¼Œè€Œä¸èƒ½åƒ Flux ä¸­ç›´æ¥ ä» Store å–ã€‚
* å½“ä¸€ä¸ªç»„ä»¶ç›¸å…³æ•°æ®æ›´æ–°æ—¶ï¼Œå³ä½¿çˆ¶ç»„ä»¶ä¸éœ€è¦ç”¨åˆ°è¿™ä¸ªç»„ä»¶ï¼Œçˆ¶ç»„ä»¶è¿˜æ˜¯ä¼š re-renderï¼Œå¯èƒ½ä¼šæœ‰æ•ˆç‡å½±å“ï¼Œæˆ–è€…éœ€è¦å†™å¤æ‚çš„ `shouldComponentUpdate` è¿›è¡Œåˆ¤æ–­ã€‚