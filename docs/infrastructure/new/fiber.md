---
nav:
  title: æ¶æ„
  order: 2
group:
  title: æ–°ç‰ˆæ¶æ„
  order: 1
title: Fiber
order: 1
---

# Fiber

Fiber æ˜¯ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§ç­–ç•¥å’Œå¸§é—´å›è°ƒçš„å¾ªç¯ä»»åŠ¡è°ƒåº¦ç®—æ³•çš„æ¶æ„æ–¹æ¡ˆã€‚

**é—®é¢˜**ï¼šéšç€åº”ç”¨å˜å¾—è¶Šæ¥è¶Šåºå¤§ï¼Œæ•´ä¸ªæ›´æ–°æ¸²æŸ“çš„è¿‡ç¨‹å¼€å§‹å˜å¾—åƒåŠ›ï¼Œå¤§é‡çš„ç»„ä»¶æ¸²æŸ“ä¼šå¯¼è‡´ä¸»è¿›ç¨‹é•¿æ—¶é—´è¢«å ç”¨ï¼Œå¯¼è‡´ä¸€äº›åŠ¨ç”»æˆ–é«˜é¢‘æ“ä½œå‡ºç°å¡é¡¿å’Œæ‰å¸§çš„æƒ…å†µã€‚è€Œå…³é”®ç‚¹ï¼Œä¾¿æ˜¯ **åŒæ­¥é˜»å¡**ã€‚åœ¨ä¹‹å‰çš„è°ƒåº¦ç®—æ³•ä¸­ï¼ŒReact éœ€è¦å®ä¾‹åŒ–æ¯ä¸ªç±»ç»„ä»¶ï¼Œç”Ÿæˆä¸€æ£µç»„ä»¶æ ‘ï¼Œä½¿ç”¨ **åŒæ­¥é€’å½’** çš„æ–¹å¼è¿›è¡Œéå†æ¸²æŸ“ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ— æ³• **æš‚åœå’Œæ¢å¤**ã€‚

**è§£å†³æ–¹æ³•**ï¼šå½“é‡åˆ°è¿›ç¨‹åŒæ­¥é˜»å¡çš„é—®é¢˜æ—¶ï¼Œ**ä»»åŠ¡åˆ†å‰²**ã€**å¼‚æ­¥è°ƒç”¨** å’Œ **ç¼“å­˜ç­–ç•¥** æ˜¯ä¸‰ä¸ªæ˜¾è‘—çš„è§£å†³æ€è·¯ã€‚è€Œ React Fiber ä¾¿æ˜¯ä¸ºäº†å®ç°ä»»åŠ¡åˆ†å‰²è€Œè¯ç”Ÿçš„ã€‚

> ğŸ’¡ Fiber æ¶æ„çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ **ä»»åŠ¡æ‹†åˆ†** å’Œ **ååŒ**ï¼Œä¸»åŠ¨æŠŠæ‰§è¡Œæƒäº¤ç»™ä¸»çº¿ç¨‹ï¼Œä½¿ä¸»çº¿ç¨‹æœ‰æ—¶é—´ç©ºæ¡£å¤„ç†å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚

## æ¶æ„èƒŒæ™¯

ç©¶å…¶åŸå› æ˜¯æµè§ˆå™¨çš„æ¸²æŸ“å¼•æ“æ˜¯å•çº¿ç¨‹ï¼Œå®ƒå°† GUI æç»˜ã€æ—¶é—´å™¨å¤„ç†ã€äº‹ä»¶å¤„ç†ã€JavaScript æ‰§è¡Œã€è¿œç¨‹èµ„æºåŠ è½½é€šé€šæ”¾åœ¨ä¸€èµ·ã€‚å½“åšæŸä»¶äº‹ï¼Œåªæœ‰å°†å®ƒåšå®Œæ‰èƒ½åšä¸‹ä¸€ä»¶äº‹ã€‚å¦‚æœæœ‰è¶³å¤Ÿçš„æ—¶é—´ï¼Œæµè§ˆå™¨æ˜¯ä¼šå¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œ**ç¼–è¯‘ä¼˜åŒ–**ï¼ˆJITï¼‰åŠè¿›è¡Œ**çƒ­ä»£ç ä¼˜åŒ–**ï¼Œä¸€äº› DOM æ“ä½œï¼Œå†…éƒ¨ä¹Ÿä¼šå¯¹ Reflowï¼ˆé‡ç»˜ï¼‰è¿›è¡Œå¤„ç†ã€‚ Reflow æ˜¯ä¸€ä¸ªæ€§èƒ½é»‘æ´ï¼Œå¾ˆå¯èƒ½è®©é¡µé¢çš„å¤§å¤šæ•°å…ƒç´ è¿›è¡Œé‡æ–°å¸ƒå±€ã€‚

### æµè§ˆå™¨ä¸­çš„å¸§

> ä¹‹å‰çš„é—®é¢˜ä¸»è¦çš„é—®é¢˜æ˜¯ä»»åŠ¡ä¸€æ—¦æ‰§è¡Œï¼Œå°±æ— æ³•ä¸­æ–­ï¼ŒJavaScript å¼•æ“çº¿ç¨‹ä¸€ç›´å ç”¨ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´å¡é¡¿ã€‚

é¡µé¢æ˜¯ä¸€å¸§ä¸€å¸§ç»˜åˆ¶å‡ºæ¥çš„ï¼Œå½“æ¯ç§’ç»˜åˆ¶çš„å¸§æ•°ï¼ˆFPSï¼‰è¾¾åˆ° 60 æ—¶ï¼Œé¡µé¢æ˜¯æµç•…çš„ï¼Œå°äºè¿™ä¸ªå€¼æ—¶ï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚

1 ç§’ 60 å¸§ï¼Œæ‰€ä»¥æ¯å¸§åˆ†åˆ°çš„æ—¶é—´æ˜¯ `1000/60 â‰ˆ 16.6 ms`ã€‚æ‰€ä»¥æˆ‘ä»¬ç¼–å†™ä»£ç æ—¶åŠ›æ±‚ä¸è®©ä¸€å¸§çš„å·¥ä½œé‡è¶…è¿‡ 16.6msã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/life-of-a-frame.png';

export default () => <img alt="Life of a Frame" src={img} width={800} />;
```

é€šè¿‡ä¸Šå›¾å¯çœ‹åˆ°ï¼Œä¸€å¸§å†…å¯å®Œæˆå¦‚ä¸‹å…­ä¸ªæ­¥éª¤çš„ä»»åŠ¡ï¼š

- ç”¨æˆ·äº¤äº’è¾“å…¥äº‹ä»¶ï¼ˆInput eventsï¼‰
  - Blocking input eventsï¼ˆé˜»å¡è¾“å…¥äº‹ä»¶ï¼‰ï¼šä¾‹å¦‚ `touch` æˆ– `wheel`
  - Non-blocking input eventsï¼ˆéé˜»å¡è¾“å…¥äº‹ä»¶ï¼‰ï¼šä¾‹å¦‚ `click` æˆ– `keypress`
- JavaScript å¼•æ“è§£ææ‰§è¡Œï¼šæ‰§è¡Œå®šæ—¶å™¨ï¼ˆTimersï¼‰äº‹ä»¶ç­‰å›è°ƒ
- å¸§å¼€å§‹ï¼ˆBegin frameï¼‰ï¼šæ¯ä¸€å¸§äº‹ä»¶ï¼ˆPer frame eventsï¼‰ï¼Œä¾‹å¦‚ `window resize`ã€`scroll` æˆ– `media query change`
- rAFï¼ˆrequestAnimationFrameï¼‰
- é¡µé¢å¸ƒå±€ï¼ˆLayoutï¼‰ï¼šè®¡ç®—æ ·å¼ï¼ˆRecalculate styleï¼‰å’Œæ›´æ–°å¸ƒå±€ï¼ˆUpdate Layoutï¼‰
- ç»˜åˆ¶æ¸²æŸ“ï¼ˆPaintï¼‰ï¼šåˆæˆæ›´æ–°ï¼ˆCompositing updateï¼‰ã€é‡ç»˜éƒ¨åˆ†èŠ‚ç‚¹ï¼ˆPaint invalidationï¼‰å’Œ Record
- æ‰§è¡Œ RIC (RequestIdelCallback)

å¦‚æœè¿™ä¸ƒä¸ªæ­¥éª¤ä¸­ï¼Œä»»æ„ä¸€ä¸ªæ­¥éª¤æ‰€å ç”¨çš„æ—¶é—´è¿‡é•¿ï¼Œæ€»æ—¶é—´è¶…è¿‡ 16ms åï¼Œç”¨æˆ·ä¸šåŠ¡å°±èƒ½çœ‹åˆ°æ˜æ˜¾çš„å¡é¡¿ã€‚

è€Œåœ¨ä¸ŠèŠ‚æåˆ°çš„ **è°ƒå’Œé˜¶æ®µ** èŠ±çš„æ—¶é—´è¿‡é•¿ï¼Œä¹Ÿå°±æ˜¯ JavaScript æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨ç”¨æˆ·æœ‰äº¤äº’çš„æ—¶å€™ï¼Œæœ¬æ¥åº”è¯¥æ¸²æŸ“ä¸‹ä¸€å¸§ï¼Œä½†æ˜¯åœ¨å½“å‰ä¸€å¸§é‡Œè¿˜åœ¨æ‰§è¡Œ JavaScriptï¼Œå°±å¯¼è‡´ç”¨æˆ·äº¤äº’ä¸èƒ½é©¬ä¸Šå¾—åˆ°åé¦ˆï¼Œä»è€Œäº§ç”Ÿå¡é¡¿æ„Ÿã€‚

> Qï¼šæ—¢ç„¶åˆè¡·æ˜¯ä¸å¸Œæœ› JavaScript ä¸å—æ§åˆ¶åœ°é•¿æ—¶é—´æ‰§è¡Œï¼ˆæƒ³è¦æ‰‹åŠ¨è°ƒåº¦ï¼‰ï¼Œé‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆåœ¨ React çš„ä½¿ç”¨ä¸­ JavaScript é•¿æ—¶é—´æ‰§è¡Œä¼šå½±å“äº¤äº’å“åº”ã€åŠ¨ç”»ï¼Ÿ
>
> Aï¼šå› ä¸ºåœ¨ React v16 ä¹‹å‰ï¼Œ`reconciliation` å¤„ç†æ¡†æ¶å†…éƒ¨æ›´æ–°äº‹åŠ¡çš„ç®—æ³•ç®€å•è¯´å°±æ˜¯ä¸€ä¸ª **è‡ªé¡¶å‘ä¸‹çš„é€’å½’ç®—æ³•**ï¼Œäº§å‡ºéœ€è¦å¯¹å½“å‰ DOM è¿›è¡Œæ›´æ–°æˆ–æ›¿æ¢çš„æ“ä½œåˆ—è¡¨ï¼Œä¸€æ—¦å¼€å§‹ï¼Œä¼š **æŒç»­å ç”¨** ä¸»çº¿ç¨‹ï¼Œä¸­æ–­æ“ä½œå´ä¸å®¹æ˜“å®ç°ã€‚å½“ JavaScript é•¿æ—¶é—´æ‰§è¡Œæ—¶ï¼ˆå¦‚å¤§é‡è®¡ç®—ç­‰ï¼‰ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸Šæ–‡æ‰€è¯´çš„é˜»å¡æ ·å¼è®¡ç®—ã€ç»˜åˆ¶ç­‰å·¥ä½œï¼Œå‡ºç°é¡µé¢è„±å¸§ç°è±¡ã€‚

### è§£å†³æ–¹æ¡ˆ

æŠŠæ¸²æŸ“æ›´æ–°è¿‡ç¨‹æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œæ¯æ¬¡åªåšä¸€å°éƒ¨åˆ†ï¼Œåšå®Œçœ‹æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæœ‰ç»§ç»­ä¸‹ä¸ªä»»åŠ¡ï¼›å¦‚æœæ²¡æœ‰ï¼ŒæŒ‚èµ·å½“å‰ä»»åŠ¡ï¼Œå°†æ—¶é—´æ§åˆ¶æƒäº¤ç»™ä¸»çº¿ç¨‹ï¼Œç­‰ä¸»çº¿ç¨‹ä¸å¿™çš„æ—¶å€™å†ç»§ç»­æ‰§è¡Œã€‚è¿™ç§ç­–ç•¥å«åš [Cooperative Schedulingï¼ˆåˆä½œå¼è°ƒåº¦ï¼‰](https://www.w3.org/TR/requestidlecallback/)ï¼Œæ“ä½œç³»ç»Ÿå¸¸ç”¨ä»»åŠ¡è°ƒåº¦ç­–ç•¥ä¹‹ä¸€ã€‚

> **è¡¥å……çŸ¥è¯†**
>
> æ“ä½œç³»ç»Ÿå¸¸ç”¨ä»»åŠ¡è°ƒåº¦ç­–ç•¥ï¼šå…ˆæ¥å…ˆæœåŠ¡ï¼ˆFCFSï¼‰è°ƒåº¦ç®—æ³•ã€çŸ­ä½œä¸šï¼ˆè¿›ç¨‹ï¼‰æœ‰é™è°ƒåº¦ç®—æ³•ï¼ˆSJ/PFï¼‰ã€æœ€é«˜ä¼˜å…ˆæƒä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼ˆFPFï¼‰ã€é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼ˆHRNï¼‰ã€æ—¶é—´ç‰‡è½®è½¬æ³•ï¼ˆRRï¼‰ã€å¤šçº§é˜Ÿåˆ—åé¦ˆæ³•ã€‚

åˆä½œå¼è°ƒåº¦ä¸»è¦å°±æ˜¯ç”¨æ¥åˆ†é…ä»»åŠ¡çš„ï¼Œå½“æœ‰æ›´æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ï¼Œä¸ä¼šé©¬ä¸Šå»åš Diff æ“ä½œï¼Œè€Œæ˜¯å…ˆæŠŠå½“å‰çš„æ›´æ–°é€å…¥ä¸€ä¸ª **Update Queue** ä¸­ï¼Œç„¶åäº¤ç»™ **Scheduler** å»å¤„ç†ï¼ŒScheduler ä¼šæ ¹æ®å½“å‰ä¸»çº¿ç¨‹çš„ä½¿ç”¨æƒ…å†µå»å¤„ç†è¿™æ¬¡ Updateã€‚ä¸ºäº†å®ç°è¿™ç§ç‰¹æ€§ï¼Œä½¿ç”¨ `requestIdleCallback` APIã€‚å¯¹äºä¸æ”¯æŒè¿™ä¸ª API çš„æµè§ˆå™¨ï¼ŒReact ä¼šåŠ ä¸Š pollyfillã€‚

åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»çŸ¥é“æµè§ˆå™¨æ˜¯ä¸€å¸§ä¸€å¸§æ‰§è¡Œçš„ï¼Œåœ¨ä¸¤ä¸ªæ‰§è¡Œå¸§ä¹‹é—´ï¼Œä¸»çº¿ç¨‹é€šå¸¸ä¼šæœ‰ä¸€å°æ®µç©ºé—²æ—¶é—´ï¼Œ`requestIdleCallback` å¯ä»¥åœ¨è¿™ä¸ª **ç©ºé—²æœŸï¼ˆIdle Periodï¼‰è°ƒç”¨ç©ºé—²æœŸå›è°ƒï¼ˆIdle Callbackï¼‰**ï¼Œæ‰§è¡Œä¸€äº›ä»»åŠ¡ã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/idle-period-time.png';

export default () => <img alt="Idle Period" src={img} width={800} />;
```

- ä½ä¼˜å…ˆçº§ä»»åŠ¡ç”± `requestIdleCallback` å¤„ç†
- é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¦‚åŠ¨ç”»ç›¸å…³çš„å°±ç”± `reuqestAnimationFrame` å¤„ç†
- `requestIdleCallback` å¯ä»¥åœ¨å¤šä¸ªç©ºé—²æœŸè°ƒç”¨ç©ºé—²æœŸå›è°ƒï¼Œæ‰§è¡Œä»»åŠ¡
- `requestIdleCallback` æ–¹æ³•æä¾› deadlineï¼Œå³ä»»åŠ¡æ‰§è¡Œé™åˆ¶æ—¶é—´ï¼Œä»¥åˆ‡åˆ†ä»»åŠ¡ï¼Œé¿å…é•¿æ—¶é—´æ‰§è¡Œï¼Œé˜»å¡ UI æ¸²æŸ“è€Œå¯¼è‡´æ‰å¸§

è¿™ä¸ªæ–¹æ¡ˆçœ‹ä¼¼ç¡®å®ä¸é”™ï¼Œä½†æ˜¯æ€ä¹ˆå®ç°å¯èƒ½ä¼šé‡åˆ°å‡ ä¸ªé—®é¢˜ï¼š

- å¦‚ä½•æ‹†åˆ†æˆå­ä»»åŠ¡ï¼Ÿ
- ä¸€ä¸ªå­ä»»åŠ¡å¤šå¤§åˆé€‚ï¼Ÿ
- æ€ä¹ˆåˆ¤æ–­æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Ÿ
- æœ‰å‰©ä½™æ—¶é—´æ€ä¹ˆå»è°ƒåº¦åº”è¯¥æ‰§è¡Œå“ªä¸ªä»»åŠ¡ï¼Ÿ
- æ²¡æœ‰å‰©ä½™æ—¶é—´ä¹‹å‰çš„ä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ

æ¥ä¸‹æ¥æ•´ä¸ª Fiber æ¶æ„å°±æ˜¯æ¥è§£å†³è¿™äº›é—®é¢˜çš„ã€‚

## åŸæœ‰æ¶æ„

åœ¨å¼€å§‹ä»‹ç» Fiber æ¶æ„å‰ï¼Œæˆ‘ä»¬å…ˆå¯¹ React16 ä¹‹å‰çš„æ¶æ„æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚

React è¿™ä¸ªçº¯è§†å›¾åº“å¯ä»¥åˆ†ä¸ºä¸‰å±‚æ¶æ„ï¼š

- **è™šæ‹Ÿ DOM å±‚**ï¼šè´Ÿè´£æè¿°ç»“æ„ä¸é€»è¾‘
- **å†…éƒ¨ç»„ä»¶å±‚**ï¼šè´Ÿè´£ç»„ä»¶çš„æ›´æ–°ï¼Œ`ReactDOM.render`ã€`setState`ã€`forceUpdate` éƒ½æ˜¯ä¸å®ƒä»¬æ‰“äº¤é“ï¼Œèƒ½è®©ä½ å¤šæ¬¡ `setState`ï¼Œåªæ‰§è¡Œä¸€æ¬¡çœŸå®çš„æ¸²æŸ“ï¼Œåœ¨é€‚å½“çš„æ—¶æœºæ‰§è¡Œç»„ä»¶å®ä¾‹å†…ç”Ÿå‘½å‘¨æœŸé’©å­
- **åº•å±‚æ¸²æŸ“å±‚**ï¼šä¸åŒçš„æ˜¾ç¤ºä»‹è´¨æœ‰ä¸åŒçš„æ¸²æŸ“æ–¹æ³•ï¼Œæ¯”å¦‚è¯´æµè§ˆå™¨ç«¯ï¼Œå®ƒä½¿ç”¨å…ƒç´ èŠ‚ç‚¹ã€æ–‡æœ¬èŠ‚ç‚¹ï¼Œåœ¨ Native ç«¯ï¼Œä¼šè°ƒç”¨ Object-C å’Œ Java çš„ GUIï¼Œåœ¨ Canvas ä¸­ï¼Œåˆæœ‰ä¸“é—¨çš„ API æ–¹æ³•

ç”±äºè™šæ‹Ÿ DOM ç”± JSX è½¬è¯‘è¿‡æ¥ï¼ŒJSX çš„å…¥å£å‡½æ•°æ˜¯ `React.createElement`ï¼Œå¯æ“ä½œç©ºé—´ä¸å¤§ï¼Œç¬¬ä¸‰å¤§çš„åº•å±‚ API ä¹Ÿéå¸¸ç¨³å®šï¼Œå› æ­¤å¯¹äº React å›¢é˜Ÿæ¥è¯´å¯ä¼˜åŒ–ç©ºé—´è¾ƒå¤§çš„æ¶æ„å±‚åªèƒ½æ˜¯ç¬¬äºŒå±‚ã€‚

## æ ¸å¿ƒæµç¨‹

### å·¥ä½œå•å…ƒ

ä¸ºäº†è§£å†³ä¹‹å‰æåˆ°è§£å†³æ–¹æ¡ˆé‡åˆ°çš„é—®é¢˜ï¼Œæå‡ºäº†ä»¥ä¸‹å‡ ä¸ªç›®æ ‡ï¼š

- æš‚åœå·¥ä½œï¼Œç¨åå†å›æ¥ã€‚
- ä¸ºä¸åŒç±»å‹çš„å·¥ä½œåˆ†é…ä¼˜å…ˆæƒã€‚
- é‡ç”¨ä»¥å‰å®Œæˆçš„å·¥ä½œã€‚
- å¦‚æœä¸å†éœ€è¦ï¼Œåˆ™ä¸­æ­¢å·¥ä½œã€‚

ä¸ºäº†åšåˆ°è¿™äº›ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ç§æ–¹æ³•å°†ä»»åŠ¡åˆ†è§£ä¸ºå•å…ƒã€‚ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œè¿™å°±æ˜¯ Fiberï¼ŒFiber ä»£è¡¨ä¸€ç§ **å·¥ä½œå•å…ƒ**ã€‚

ä½†æ˜¯ä»…ä»…æ˜¯åˆ†è§£ä¸ºå•å…ƒä¹Ÿæ— æ³•åšåˆ°ä¸­æ–­ä»»åŠ¡ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨æ ˆå°±æ˜¯è¿™æ ·ï¼Œæ¯ä¸ªå‡½æ•°ä¸ºä¸€ä¸ªå·¥ä½œä»»åŠ¡ï¼ˆworkï¼‰ï¼Œæ¯ä¸ªå·¥ä½œä»»åŠ¡ï¼ˆworkï¼‰è¢«ç§°ä¸º **å †æ ˆå¸§**ï¼Œå®ƒä¼šä¸€ç›´å·¥ä½œï¼Œç›´åˆ°å †æ ˆä¸ºç©ºï¼Œæ— æ³•ä¸­æ–­ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ **å¢é‡æ¸²æŸ“** çš„è°ƒåº¦ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°å®ç°ä¸€ä¸ªå †æ ˆå¸§çš„è°ƒåº¦ï¼Œè¿™ä¸ªå †æ ˆå¸§å¯ä»¥æŒ‰ç…§è‡ªå·±çš„è°ƒåº¦ç®—æ³•æ‰§è¡Œä»–ä»¬ã€‚å¦å¤–ç”±äºè¿™äº›å †æ ˆæ˜¯å¯ä»¥è‡ªå·±æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¯ä»¥åŠ å…¥ **å¹¶å‘** æˆ–è€… **é”™è¯¯è¾¹ç•Œ** ç­‰åŠŸèƒ½ã€‚

å› æ­¤ Fiber å°±æ˜¯é‡æ–°å®ç°çš„å †æ ˆå¸§ï¼Œè€Œéä½¿ç”¨ JavaScript å¼•æ“çš„æ ˆï¼Œæœ¬è´¨ä¸Š Fiber ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ª **è™šæ‹Ÿçš„å †æ ˆå¸§**ï¼Œå°†å¯ä¸­æ–­çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œé€šè¿‡æŒ‰ç…§ä¼˜å…ˆçº§æ¥è‡ªç”±è°ƒåº¦å­ä»»åŠ¡ï¼Œåˆ†æ®µæ›´æ–°ï¼Œä»è€Œå°†ä¹‹å‰çš„ **åŒæ­¥æ¸²æŸ“** æ”¹ä¸º **å¼‚æ­¥æ¸²æŸ“**ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ Fiber æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼ˆå †æ ˆå¸§ï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§è§£å†³å¯ä¸­æ–­çš„è°ƒç”¨ä»»åŠ¡çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå®ƒçš„ç‰¹æ€§å°±æ˜¯ **æ—¶é—´åˆ†ç‰‡ï¼ˆtime slicingï¼‰** å’Œ **æš‚åœï¼ˆsupenseï¼‰**ã€‚

å¦‚æœäº†è§£ **åç¨‹** çš„å¯èƒ½ä¼šè§‰å¾— Fiber çš„è¿™ç§è§£å†³æ–¹æ¡ˆï¼Œè·Ÿåç¨‹æœ‰ç‚¹åƒï¼ˆåŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼‰ï¼Œæ˜¯å¯ä»¥ä¸­æ–­çš„ï¼Œå¯ä»¥æ§åˆ¶æ‰§è¡Œé¡ºåºã€‚åœ¨ JavaScript é‡Œçš„ `generator` å…¶å®å°±æ˜¯ä¸€ç§åç¨‹çš„ä½¿ç”¨æ–¹å¼ï¼Œä¸è¿‡é¢—ç²’åº¦æ›´å°ï¼Œå¯ä»¥æ§åˆ¶å‡½æ•°é‡Œé¢çš„ä»£ç è°ƒç”¨çš„é¡ºåºï¼Œä¹Ÿå¯ä»¥ä¸­æ–­ã€‚

### å·¥ä½œæµç¨‹

> Fiber æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

1. `ReactDOM.render()` å’Œ `setState` çš„æ—¶å€™å¼€å§‹åˆ›å»ºæ›´æ–°
2. å°†åˆ›å»ºçš„æ›´æ–°åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦
3. åœ¨ `requestIdleCallback` ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡
4. ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå† Fiber Nodeï¼Œå¹¶ä¸”æ„å»º WorkInProgress Tree
5. ç”Ÿæˆ EffectList
6. æ ¹æ® EffectList æ›´æ–° DOM

ä¸‹é¢æ˜¯ä¸€ä¸ªè¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹å›¾ï¼š

```jsx | inline
import React from 'react';
import img from '../../assets/fiber-workflow.png';

export default () => <img alt="React Fiber Workflow" src={img} width={800} />;
```

1. ç¬¬ä¸€éƒ¨åˆ†ä» `ReactDOM.render` æ–¹æ³•å¼€å§‹ï¼ŒæŠŠæ¥æ”¶çš„ React Element è½¬æ¢ä¸º Fiber èŠ‚ç‚¹ï¼Œå¹¶ä¸ºå…¶[è®¾ç½®ä¼˜å…ˆçº§](#ä¼˜å…ˆçº§ç­–ç•¥)ï¼Œåˆ›å»º Updateï¼ŒåŠ å…¥åˆ°æ›´æ–°é˜Ÿåˆ—ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æ˜¯åšä¸€äº›åˆå§‹æ•°æ®çš„å‡†å¤‡ã€‚
2. ç¬¬äºŒéƒ¨åˆ†ä¸»è¦æ˜¯ä¸‰ä¸ªå‡½æ•°ï¼š`scheduleWork`ã€`requestWork`ã€`performWork`ï¼Œå³å®‰æ’å·¥ä½œã€ç”³è¯·å·¥ä½œã€æ­£å¼å·¥ä½œä¸‰éƒ¨æ›²ï¼ŒReact16 æ–°å¢çš„å¼‚æ­¥è°ƒç”¨çš„åŠŸèƒ½åˆ™åœ¨è¿™éƒ¨åˆ†å®ç°ï¼Œè¿™éƒ¨åˆ†å°±æ˜¯ **Schedule é˜¶æ®µ**ï¼Œå‰é¢ä»‹ç»çš„ Cooperative Scheduling å°±æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µï¼Œåªæœ‰åœ¨è¿™ä¸ªè§£å†³è·å–åˆ°å¯æ‰§è¡Œçš„æ—¶é—´ç‰‡ï¼Œç¬¬ä¸‰éƒ¨åˆ†æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚
3. ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ä¸ªå¤§å¾ªç¯ï¼Œéå†æ‰€æœ‰çš„ Fiber èŠ‚ç‚¹ï¼Œé€šè¿‡ Diff ç®—æ³•è®¡ç®—æ‰€æœ‰æ›´æ–°å·¥ä½œï¼Œäº§å‡º EffectList ç»™åˆ° Commit é˜¶æ®µä½¿ç”¨ï¼Œè¿™éƒ¨åˆ†çš„æ ¸å¿ƒå°±æ˜¯ `beginWork` å‡½æ•°ï¼Œè¿™éƒ¨åˆ†åŸºæœ¬å°±æ˜¯ **FIber Reconciler**ï¼ŒåŒ…æ‹¬ **reconciliation** å’Œ **commit** é˜¶æ®µã€‚

### Fiber Tree

React è¿è¡Œæ—¶å­˜åœ¨ä¸‰ç§å®ä¾‹ï¼ˆç»“åˆä¸Šæ–‡æåˆ°çš„ React ä¸‰å±‚æ¶æ„ç†è§£ï¼‰ï¼š

```plain
Element - æè¿° UI ç»“æ„å†…å®¹ï¼ˆtypeã€propsï¼‰
--------
Instances - React ç»´æŠ¤çš„ VirtualDOM Tree Node
--------
DOM - çœŸå® DOM èŠ‚ç‚¹
```

React åœ¨é¦–æ¬¡æ¸²æŸ“ï¼ˆæ‰§è¡Œ `ReactDOM.render`ï¼‰æ—¶ï¼Œä¼šé€šè¿‡ `React.createElement` åˆ›å»ºä¸€é¢— Element æ ‘ï¼Œå¯ä»¥ç§°ä¹‹ä¸º **Virtual DOM Tree**ï¼Œç”±äºè¦è®°å½•ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŠ å…¥äº† Fiberï¼Œæ¯ä¸€ä¸ª Element ä¼šå¯¹åº”ä¸€ä¸ª Fiber Nodeï¼Œå°† Fiber Node é“¾æ¥èµ·æ¥çš„ç»“æ„æˆä¸º Fiber Treeã€‚å®ƒåæ˜ äº†ç”¨äºæ¸²æŸ“ UI çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚è¿™æ£µæ ‘é€šå¸¸è¢«ç§°ä¸º **current æ ‘ï¼ˆå½“å‰æ ‘ï¼Œè®°å½•å½“å‰é¡µé¢çš„ç»“æ„çŠ¶æ€ï¼‰**ã€‚

åœ¨åç»­çš„æ›´æ–°è¿‡ç¨‹ä¸­ï¼ˆ`setState`ï¼‰ï¼Œæ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½ä¼šé‡æ–°åˆ›å»º Elementï¼Œä½†æ˜¯ Fiber ä¸ä¼šï¼ŒFiber åªä¼šä½¿ç”¨å¯¹åº”çš„ Element ä¸­çš„æ•°æ®æ¥æ›´æ–°è‡ªå·±å¿…è¦çš„å±æ€§ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨ Fiber å‡ºç°ä¹‹å‰çš„ `reconciler`ï¼ˆç§°ä¸º Stack Reconcilerï¼‰æ˜¯é‡‡å–è‡ªé¡¶å‘ä¸‹é€’å½’æ¯”è¾ƒæ¥å®ç°çš„ï¼Œæ‰€ä»¥ <span style="color: red;font-weight: bold;">æ— æ³•ä¸­æ–­è¿™ä¸ªé€’å½’æ¯”è¾ƒçš„è¿‡ç¨‹</span>ï¼ˆæŒç»­å ç”¨ä¸»çº¿ç¨‹ï¼‰ï¼Œè¿™æ ·ä¸»çº¿ç¨‹ä¸Šçš„å¸ƒå±€ã€åŠ¨ç”»ç­‰å‘¨æœŸæ€§ä»»åŠ¡ä»¥åŠäº¤äº’å“åº”å°±æ— æ³•ç«‹å³å¾—åˆ°å¤„ç†ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

> âš ï¸ **æ³¨æ„**ï¼šFiber ä¹‹å‰çš„ `reconciler` è¢«ç§°ä¸º Stack Reconcilerï¼Œå°±æ˜¯å› ä¸ºè¿™äº›è°ƒåº¦ä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ç”±ç³»ç»Ÿæ ˆæ¥ä¿å­˜çš„ã€‚è™½ç„¶ä¹‹å‰ä¸€æ¬¡æ€§åšå®Œï¼Œå¼ºè°ƒæ ˆæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œèµ·ä¸ªåå­—åªæ˜¯ä¸ºäº†ä¾¿äºåŒºåˆ† Fiber Reconcilerã€‚

Fiber è§£å†³è¿™ä¸ªé—®é¢˜çš„ **æ€è·¯** æ˜¯æŠŠæ¸²æŸ“/æ›´æ–°è¿‡ç¨‹ï¼ˆé€’å½’ `diff`ï¼‰æ‹†åˆ†ä¸ºä¸€ç³»åˆ—å°ä»»åŠ¡ï¼Œæ¯æ¬¡æ£€æŸ¥æ ‘ä¸Šçš„ä¸€å°éƒ¨åˆ†ï¼Œå®Œæˆåæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ—¶é—´ç»§ç»­ä¸‹ä¸ªä»»åŠ¡ï¼Œæœ‰çš„è¯ç»§ç»­ï¼Œæ²¡æœ‰çš„è¯è‡ªå·±æŒ‚èµ·ï¼Œä¸»çº¿ç¨‹ä¸å¿™çš„æ—¶å€™å†ç»§ç»­ã€‚

å¢é‡æ›´æ–°éœ€è¦æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¹‹å‰çš„ VirtualDOM Tree æ˜¾ç„¶éš¾ä»¥æ»¡è¶³ï¼Œæ‰€ä»¥æ‰©å±•å‡ºäº† Fiber Treeï¼Œæ›´æ–°è¿‡ç¨‹å°±æ˜¯æ ¹æ®è¾“å…¥æ•°æ®ä»¥åŠç°æœ‰çš„ Fiber Tree æ„é€ å‡ºæ–°çš„ä¸´æ—¶çš„ Fiber Treeï¼ˆWorkInProgress treeï¼‰ã€‚

å› æ­¤ï¼ŒInstances å±‚æ–°å¢äº†è¿™äº›å®ä¾‹ï¼š

```plain
React Elements
    æè¿° UI é•¿ä»€ä¹ˆæ ·å­ï¼ˆtypeã€propsï¼‰
--------
Fiber
    Fiber Tree ä¸ VirtualDOM Tree ç±»ä¼¼ï¼Œç”¨äºæè¿°å¢é‡æ›´æ–°æ‰€éœ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
--------
WorkInProgress
    workInProgress Tree æ˜¯ Reconcile è¿‡ç¨‹ä¸­ä» Fiber Tree ç®€å†çš„å½“å‰è¿›åº¦å¿«ç…§ï¼Œç”¨äºæ–­ç”µæ¢å¤
--------
Effect
    æ¯ä¸ª workInProgress Tree èŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ª Effect List
    ç”¨äºå­˜æ”¾ diff ç»“æœ
    å½“å‰èŠ‚ç‚¹æ›´æ–°å®Œæ¯•åä¼šå‘ä¸Š merge Effect Listï¼ˆQueue æ”¶é›† diff ç»“æœï¼‰
--------
DOM
    çœŸå® DOM èŠ‚ç‚¹
```

> âš ï¸ **æ³¨æ„**ï¼šæ”¾åœ¨è™šçº¿ä¸Šçš„ä¸¤å±‚ï¼ˆWorkInProgress å’Œ Effectï¼‰éƒ½æ˜¯ä¸´æ—¶çš„ç»“æ„ï¼Œä»…åœ¨æ›´æ–°æ—¶æœ‰ç”¨ï¼Œæ—¥å¸¸ä¸æŒç»­ç»´æŠ¤ã€‚`Effect` æŒ‡çš„å°±æ˜¯ `side effect`ï¼ŒåŒ…æ‹¬å°†è¦åšçš„ `DOM Change`ã€‚

Fiber Tree ä¸Šå„èŠ‚ç‚¹çš„ä¸»è¦ç»“æ„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ç§°ä¸º FiberNodeï¼‰å¦‚ä¸‹ï¼š

```js
type Fiber {
  // æ ‡è¯† React å…ƒç´ çš„ç±»å‹ï¼Œå¸¸è§çš„æœ‰ FunctionComponentã€ClassCOmponentã€Fragmentã€ContextConsumer
  tag: WorkTag,
  // ReactElement.typeï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ createElement çš„ç¬¬ä¸€ä¸ªå‚æ•°
  elementType: any,
  // å¼‚æ­¥ç»„ä»¶ resolve ä¹‹åè¿”å›çš„å†…å®¹ï¼Œä¸€èˆ¬æ˜¯ function æˆ– class
  type: any,

  /* å½“å‰ Fibeer çš„çŠ¶æ€ */

  // ä¸åŒç±»å‹çš„å®ä¾‹éƒ½ä¼šè®°å½•åœ¨ stateNode ä¸Š
  // æ¯”å¦‚ DOM ç»„ä»¶å¯¹åº” DOM èŠ‚ç‚¹å®ä¾‹
  // ClassComponent å¯¹åº” Class å®ä¾‹
  // FunctionComponent æ²¡æœ‰å®ä¾‹ï¼Œæ‰€ä»¥ StateNode å€¼ä¸º null
  // state æ›´æ–°äº†æˆ– props æ›´æ–°äº†å‡ä¼šæ›´æ–°åˆ° stateNode ä¸Š
  stateNode: any,

  // æŒ‡å‘å®ƒåœ¨ Fiber èŠ‚ç‚¹æ ‘ä¸­çš„ `parent`ï¼Œç”¨äºå¤„ç†å®Œè¿™ä¸ªèŠ‚ç‚¹ä¹‹åå‘ä¸Šè¿”å›
  // è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å¤„ç†å®Œæ¯•åï¼Œåº”è¯¥å‘è°æäº¤è‡ªå·±çš„æˆæœï¼ˆeffect listï¼‰
  return: Fiber | null,
  // æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  child: Fiber | null,
  // æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œå…„å¼ŸèŠ‚ç‚¹çš„ return æŒ‡å‘åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹
  sibling: Fiber | null,

  // ref å±æ€§
  ref: null | (((handle: mixed) => void) & {_stringRef: ?string}) | RefObject,

  // æ›´æ–°ç›¸å…³
  // æ–°çš„å˜åŠ¨å¸¦æ¥çš„æ–°çš„ Propsï¼Œå³ nextProps
  pendingProps: any,
  // ä¸Šæ¬¡æ¸²æŸ“å®Œæˆä¹‹åçš„ Propsï¼Œå³ props
  memoizedProps: any,
  // è¯¥ Fiber å¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„ Update ä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œ
  updateQueue: mixed,
  // ä¸Šæ¬¡æ¸²æŸ“çš„æ—¶å€™çš„ Stateï¼Œå³ state
  // æ–°çš„ state ç”± updateQueue è®¡ç®—å¾—å‡ºï¼Œå¹¶è¦†ç›– memoizedState
  memoizedState: any,
  // ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜åœ¨è¯¥ Fiber ä¾èµ–çš„ contextsã€events
  dependencies: Dependencies | null,

  // mode æœ‰ conCurrentMode å’Œ strictMode
  // ç”¨äºæè¿°å½“å‰ Fiber å’Œå…¶ä»–å­æ ‘çš„ Bitfield
  // å…±å­˜çš„æ¨¡å¼è¡¨ç¤ºè¿™ä¸ªå­æ ‘æ˜¯å¦é»˜è®¤æ˜¯å¼‚æ­¥æ¸²æŸ“çš„
  // Fiber åˆšè¢«åˆ›å»ºæ—¶ï¼Œä¼šç»§æ‰¿çˆ¶ Fiber
  // å…¶ä»–æ ‡è¯†ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™è¢«è®¾ç½®ï¼Œä½†æ˜¯åˆ›å»ºä¹‹åä¸è¯¥è¢«ä¿®æ”¹ï¼Œç‰¹åˆ«æ˜¯å®ƒçš„å­ Fiber åˆ›å»ºä¹‹å‰
  mode: TypeOfMode,

  /* ä»¥ä¸‹æ˜¯å‰¯ä½œç”¨ï¼Œå‰¯ä½œç”¨æ˜¯æ ‡è®°ç»„ä»¶å“ªäº›éœ€è¦æ›´æ–°çš„å·¥å…·ã€æ ‡è®°ç»„ä»¶éœ€è¦æ‰§è¡Œå“ªäº›ç”Ÿå‘½å‘¨æœŸçš„å·¥å…· */

  // Effect ç±»å‹
  effectTag: SideEffectTag,
  // Effect æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸ª Effect
  nextEffect: Fiber | null,
  // Effect List å•å‘é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª Effect
  firstEffect: Fiber | null,
  // Effect List å•å‘é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ª Effect
  lastEffect: Fiber | null,

  // è¾¾æ ‡ä»»åŠ¡åœ¨æœªæ¥å“ªä¸ªæ—¶é—´ç‚¹ï¼Œåº”è¯¥è¢«å®Œæˆ
  // ä¸åŒ…æ‹¬è¯¥ Fiber çš„å­æ ‘äº§ç”Ÿçš„ä»»åŠ¡
  expirationTime: ExpirationTime,
  //å¿«é€Ÿç¡®å®šå­æ ‘ä¸­æ˜¯å¦æœ‰ update
  //å¦‚æœå­èŠ‚ç‚¹æœ‰updateçš„è¯ï¼Œå°±è®°å½•åº”è¯¥æ›´æ–°çš„æ—¶é—´
  childExpirationTime: ExpirationTime,

  // åœ¨ Fiber æ ‘æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª Fiber éƒ½ä¼šæœ‰ä¸€ä¸ªè·Ÿå…¶å¯¹åº”çš„ Fiber
  // æˆ‘ä»¬ç§°å®ƒä¸º `current <==> workInProgress`
  // åœ¨æ¸²æŸ“å®Œæˆä¹‹åå®ƒä»¬ä¼šäº¤æ¢ä½ç½®
  alternate: Fiber | null;
}
```

æ¯ä¸€ä¸ª Fiber Node èŠ‚ç‚¹ä¸ Virtual Dom ä¸€ä¸€å¯¹åº”ï¼Œæ‰€æœ‰ Fiber Node è¿æ¥èµ·æ¥å½¢æˆ Fiber Tree, æ˜¯ä¸ª**å•é“¾è¡¨æ ‘ç»“æ„**ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```jsx | inline
import React from 'react';
import img from '../../assets/fiber-tree-sample.jpeg';

export default () => <img alt="Fiber Tree Sample" src={img} width={640} />;
```

Fiber Tree é€šè¿‡èŠ‚ç‚¹ä¿å­˜ä¸æ˜ å°„ï¼Œä¾¿èƒ½å¤Ÿéšæ—¶åœ°è¿›è¡Œåœæ­¢å’Œé‡å¯ï¼Œè¿™æ ·ä¾¿èƒ½è¾¾åˆ°å®ç° **ä»»åŠ¡åˆ†å‰²** çš„åŸºæœ¬å‰æã€‚

åœ¨ React v16 å°†è°ƒåº¦ç®—æ³•è¿›è¡Œäº†é‡æ„ï¼Œå°†ä¹‹å‰çš„ Stack Reconciler é‡æ„æˆæ–°ç‰ˆçš„ Fiber Reconcilerï¼Œå˜æˆäº†å…·æœ‰é“¾è¡¨å’ŒæŒ‡é’ˆçš„ **å•é“¾è¡¨æ ‘éå†ç®—æ³•**ã€‚é€šè¿‡æŒ‡é’ˆæ˜ å°„ï¼Œæ¯ä¸ªå•å…ƒéƒ½è®°å½•ç€éå†å½“ä¸‹çš„ä¸Šä¸€æ­¥ä¸ä¸‹ä¸€æ­¥ï¼Œä»è€Œä½¿éå†å˜å¾—å¯ä»¥è¢«æš‚åœå’Œé‡å¯ã€‚

å½“ `render` çš„æ—¶å€™æœ‰äº†è¿™ä¹ˆä¸€æ¡å•é“¾è¡¨ï¼Œå½“è°ƒç”¨ `setState` çš„æ—¶å€™åˆæ˜¯å¦‚ä½• Diff å¾—åˆ° change list çš„å‘¢ï¼Ÿ

### WorInProgress Tree

é€šè¿‡ `setState` è§¦å‘ React å†…éƒ¨çš„æ›´æ–°ä»»åŠ¡åï¼Œé‡‡ç”¨çš„æ˜¯ **åŒç¼“å†²æŠ€æœ¯ï¼ˆdouble bufferingï¼‰** ä» Fiber Tree ä¸­è·å– DOM Change Listï¼Œå°±åƒ Redux é‡Œçš„ `nextListeners` ä¸€æ ·ï¼Œåœ¨ Fiber æ¶æ„ä¸­åˆ™æ˜¯ä»¥ Fiber Tree ä¸ºä¸»ï¼ŒWorkInProgress Treeï¼ˆåæ˜ çš„æ˜¯åˆ·æ–°åˆ°å±å¹•çš„æœªæ¥çŠ¶æ€ï¼‰ ä¸ºè¾…ã€‚

åŒç¼“å†²å…·ä½“æŒ‡çš„æ˜¯ WorkInProgress Tree æ„é€ å®Œæ¯•ï¼Œå¾—åˆ°çš„å°±æ˜¯æ–°çš„ Fiber Treeï¼Œç„¶åæŠŠ `current` æ ‘çš„æŒ‡é’ˆæŒ‡å‘ WorkInProgress Treeï¼Œç„¶åä¸¢æ‰æ—§çš„ Fiber Tree å³å¯ã€‚

è¿™æ ·åšçš„å¥½å¤„ï¼š

- èƒ½å¤Ÿå¤ç”¨å†…éƒ¨å¯¹è±¡ï¼ˆFiber Nodeï¼‰
- èŠ‚çœå†…å­˜åˆ†é…ã€GCï¼ˆåƒåœ¾å›æ”¶ï¼‰çš„æ—¶é—´å¼€é”€
- å°±ç®—è¿è¡Œä¸­æœ‰é”™è¯¯ï¼Œä¹Ÿä¸ä¼šå½±å“ View ä¸Šçš„é”™è¯¯ï¼ˆé”™è¯¯è¾¹ç•Œï¼‰

æ¯ä¸ª FiberNode ä¸Šéƒ½æœ‰ä¸ª `alternate` å±æ€§ï¼Œä¹ŸæŒ‡å‘ä¸€ä¸ª Fiber Nodeï¼Œåˆ›å»º WorkInProgress Tree èŠ‚ç‚¹æ—¶ä¼˜å…ˆå– `alternate`ï¼Œæ²¡æœ‰çš„è¯å°±åˆ›å»ºä¸€ä¸ªï¼š

```js
export function createWorkInProgress(
  current: Fiber,
  pendingProps: any,
  expirationTime: ExpirationTime,
): Fiber {
  let workInProgress = current.alternate;
  if (workInProgress === null) {
    workInProgress = createFiber(current.tag, pendingProps, current.key, current.mode,);
    ...
    workInProgress.alternate = current;
    current.alternate = workInProgress;
  } else {
    workInProgress.effectTag = NoEffect;
    workInProgress.nextEffect = null;
    workInProgress.firstEffect = null;
    workInProgress.lastEffect = null;
    ...
  }
  ...
  return workInProgress;
}

```

ä»¥ä¸Šä»£ç ä¸ºç®€åŒ–ä¹‹åçš„ï¼Œå¯ä»¥å‘ç°ï¼Œ`current` ä¸ `workInProgress` äº’ç›¸æŒæœ‰å¼•ç”¨ã€‚

åˆ›å»º WorkInProgress Tree çš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ª Diff è¿‡ç¨‹ï¼ŒDiff å®Œæˆä¹‹åä¼šç”Ÿæˆä¸€ä¸ª Effect Listï¼Œè¿™ä¸ª Effect List å°±æ˜¯æœ€ç»ˆ Commit é˜¶æ®µç”¨äºå¤„ç†å‰¯ä½œç”¨çš„é˜¶æ®µã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/fiber-work-in-progress.png';

export default () => <img alt="Fiber WorkInProgress Tree" src={img} width={540} />;
```

### Effect List

Effect List å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨ `effectTag` å‰¯ä½œç”¨åˆ—è¡¨å®¹å™¨ã€‚å®ƒæ˜¯ç”± Fiber èŠ‚ç‚¹å’ŒæŒ‡é’ˆ `nextEffect` æ„æˆçš„å•é“¾è¡¨ç»“æ„ï¼Œè¿™å…¶ä¸­è¿˜åŒ…æ‹¬ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ `firstEffect`ï¼Œå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ `lastEffect`ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```jsx | inline
import React from 'react';
import img from '../../assets/fiber-effect-list.png';

export default () => <img alt="Fiber Effect List" src={img} width={640} />;
```

React é‡‡ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ï¼Œåœ¨ `render` é˜¶æ®µéå† Fiber æ ‘æ—¶ï¼ŒæŠŠæ¯ä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„ Fiber ç­›é€‰å‡ºæ¥ï¼Œæœ€åæ„å»ºç”Ÿæˆä¸€ä¸ªåªå¸¦å‰¯ä½œç”¨çš„ Effect List é“¾è¡¨ã€‚

åœ¨ Commit é˜¶æ®µï¼ŒReact æ‹¿åˆ° Effect List æ•°æ®åï¼Œé€šè¿‡éå† Effect Listï¼Œå¹¶æ ¹æ®æ¯ä¸€ä¸ª Effect èŠ‚ç‚¹çš„ `effectTag` ç±»å‹ï¼Œä»è€Œå¯¹ç›¸åº”çš„ DOM æ ‘æ‰§è¡Œæ›´æ”¹ã€‚

æ›´å¤š Fffect List æ„å»ºæ¼”ç¤ºæµç¨‹ï¼Œå¯ä»¥ç‚¹å‡»æŸ¥çœ‹åŠ¨ç”» [Effect List â€”â€” åˆä¸€ä¸ª Fiber é“¾è¡¨çš„æ„å»ºè¿‡ç¨‹](https://www.bilibili.com/video/av48384879/)ã€‚

### Fiber Reconciler

åœ¨ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿›è¡Œ Schedule å®Œï¼Œè·å–åˆ°æ—¶é—´ç‰‡ä¹‹åï¼Œå°±å¼€å§‹è¿›è¡Œ `reconcile`ã€‚

Fiber Reconciler æ˜¯ React é‡Œçš„è°ƒå’Œå™¨ï¼Œè¿™ä¹Ÿæ˜¯ä»»åŠ¡è°ƒåº¦å®Œæˆä¹‹åï¼Œå¦‚ä½•å»æ‰§è¡Œæ¯ä¸ªä»»åŠ¡ï¼Œå¦‚ä½•å»æ›´æ–°æ¯ä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œå¯¹åº”ä¸Šé¢çš„ç¬¬ä¸‰ä¸ªéƒ¨åˆ†ã€‚

Fiber Reconciler çš„æ ¸å¿ƒæµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ˆphraseï¼‰ï¼š

- **Reconciliation**ï¼ˆè°ƒå’Œï¼Œè°ƒåº¦ç®—æ³•ä¹Ÿå¯ç§°ä¸º `render`ï¼‰
  - æ›´æ–° `state` ä¸ `props`
  - è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­
  - ç”Ÿæˆ Virtual DOM
    - è¿™é‡Œåº”è¯¥ç§°ä¸º Fiber Tree æ›´ä¸ºæ°å½“
  - é€šè¿‡æ–°æ—§ Virtual DOM è¿›è¡Œ diff ç®—æ³•ï¼Œè·å– Virtual Change
  - ç¡®å®šæ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
  - æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯é€šè¿‡æ„é€  WorkInProgress Tree å¾—å‡º DOM Change
- **Commit**
  - å¦‚éœ€è¦ï¼Œåˆ™æ“ä½œ DOM èŠ‚ç‚¹æ›´æ–°

### Reconciler - reconciliation é˜¶æ®µ

ä»¥ Fiber Tree ä¸ºè“æœ¬ï¼ŒæŠŠæ¯ä¸ª FiberNode ä½œä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œ**è‡ªé¡¶å‘ä¸‹é€èŠ‚ç‚¹æ„é€ ** WorkInProgress Treeï¼ˆæ„å»ºä¸­çš„æ–° Fiber Treeï¼‰ã€‚

å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä»¥ç»„ä»¶èŠ‚ç‚¹ä¸ºä¾‹ï¼‰ï¼š

1. å¦‚æœå½“å‰èŠ‚ç‚¹ä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥æŠŠå­èŠ‚ç‚¹ `clone` è¿‡æ¥ï¼Œè·³åˆ° 5ï¼›è¦æ›´æ–°çš„è¯æ‰“ä¸ª `tag`
2. æ›´æ–°å½“å‰ï¼ˆè¦æ›´æ–°ï¼‰èŠ‚ç‚¹çš„å„ç§çŠ¶æ€ï¼ˆ`props`ã€`state`ã€`context`ç­‰ï¼‰
3. è°ƒç”¨ `shouldComponentUpdate`ï¼Œåˆ¤æ–­ä¸º `false` çš„è¯ï¼Œè·³åˆ° 5
4. è°ƒç”¨ `render` è·å¾—æ–°çš„å­èŠ‚ç‚¹ï¼Œå¹¶ä¸ºå­èŠ‚ç‚¹åˆ›å»º Fiber Nodeï¼ˆåˆ›å»ºè¿‡ç¨‹ä¼šå°½é‡å¤ç”¨ç°æœ‰ Fiber Nodeï¼Œå­èŠ‚ç‚¹å¢åˆ ä¹Ÿå‘ç”Ÿåœ¨è¿™é‡Œï¼‰
5. å¦‚æœæ²¡æœ‰äº§ç”Ÿ `child fiber`ï¼Œè¯¥å·¥ä½œå•å…ƒç»“æŸï¼ŒæŠŠ `effect list` å½’å¹¶åˆ° `return`ï¼Œå¹¶æŠŠå½“å‰èŠ‚ç‚¹çš„ `sibling` ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒï¼›å¦åˆ™æŠŠ `child` ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ
6. å¦‚æœæ²¡æœ‰å‰©ä½™å¯ç”¨æ—¶é—´äº†ï¼Œç­‰åˆ°ä¸‹ä¸€æ¬¡ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰å¼€å§‹ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒï¼›å¦åˆ™ï¼Œç«‹å³å¼€å§‹åš
7. å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒäº†ï¼ˆå›åˆ°äº† WorkInProgress Tree çš„æ ¹èŠ‚ç‚¹ï¼‰ï¼Œç¬¬ 1 é˜¶æ®µç»“æŸï¼Œè¿›å…¥ `pendingCommit` çŠ¶æ€

åœ¨ Reconciliation é˜¶æ®µçš„æ¯ä¸ªå·¥ä½œå¾ªç¯ï¼ˆä¹Ÿå°±æ˜¯ä¸Šè¿°æ­¥éª¤ä¸­çš„ 1-6ï¼‰ä¸­ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ª Fiberï¼Œå¤„ç†å®Œå¯ä»¥ä¸­æ–­/æŒ‚èµ·æ•´ä¸ªå·¥ä½œå¾ªç¯ã€‚é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹æ›´æ–°ç»“æŸæ—¶å‘ä¸Šå½’å¹¶ **Effect List** æ¥æ”¶é›†ä»»åŠ¡ç»“æœï¼ŒReconciliation ç»“æŸåï¼ŒWorkInProgress Tree æ ¹èŠ‚ç‚¹çš„ Effect List é‡Œè®°å½•äº†åŒ…æ‹¬ DOM Change åœ¨å†…çš„æ‰€æœ‰ **Side Effect**ã€‚

è¿™ä¸ªé˜¶æ®µä¼šæ‰§è¡Œä»¥ä¸‹çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

- `[UNSAFE_]componentWillMount`ï¼ˆå¼ƒç”¨ï¼‰
- `[UNSAFE_]componentWillReceiveProps`ï¼ˆå¼ƒç”¨ï¼‰
- `getDerivedStateFromProps`
- `shouldComponentUpdate`
- `[UNSAFE_]componentWillUpdate`ï¼ˆå¼ƒç”¨ï¼‰
- `render`

> âš ï¸ **æ³¨æ„**ï¼šç”±äºç¬¬ 1 é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¯èƒ½ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œé»˜è®¤ä»¥ `low` ä¼˜å…ˆçº§ï¼ˆåé¢ä»‹ç»çš„å…­ç§ä¼˜å…ˆçº§ä¹‹ä¸€ï¼‰æ‰§è¡Œï¼Œè¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­çš„è¯ï¼Œç¨åé‡æ–°æ‰§è¡Œã€‚

æ„å»º WorkInProgress Tree çš„è¿‡ç¨‹å°±æ˜¯ diff çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ VirtualDOM çš„æ•°æ®å¯¹æ¯”ï¼Œæ˜¯ä¸ªé€‚åˆæ‹†åˆ†çš„é˜¶æ®µï¼Œå¯¹æ¯”ä¸€éƒ¨åˆ† VirtualDOM Tree åï¼Œé€šè¿‡ `requestIdleCallback` æ¥è°ƒåº¦æ‰§è¡Œæ¯ç»„ä»»åŠ¡ï¼Œæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡åå›æ¥çœ‹çœ‹æœ‰æ²¡æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œæœ‰çš„è¯åˆ™ç«‹å³æ‰§è¡Œï¼Œæ¯å®Œæˆä¸€ç»„ä»»åŠ¡ï¼ŒæŠŠæ—¶é—´æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»çº¿ç¨‹ï¼Œç›´åˆ°ä¸‹æ¬¡ `requestIdleCallback` å›è°ƒå†ç»§ç»­æ„å»º WorkInProgress Treeã€‚

**åˆ†æ•£æ‰§è¡Œ**ï¼šä»»åŠ¡åˆ†å‰²åï¼Œå°±å¯ä»¥æŠŠå°ä»»åŠ¡å•å…ƒåˆ†æ•£åˆ°æµè§ˆå™¨çš„ç©ºé—²æœŸé—´å» **æ’é˜Ÿæ‰§è¡Œ**ï¼Œè€Œå®ç°çš„å…³é”®æ˜¯ä¸¤ä¸ªæ–° APIï¼š`requestIdleCallback` ä¸ `requestAnimationFrame`ã€‚

- ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡äº¤ç»™ `requestIdleCallback` å¤„ç†ï¼Œè¿™æ˜¯ä¸ªæµè§ˆå™¨æä¾›çš„äº‹ä»¶å¾ªç¯ç©ºé—²æœŸçš„å›è°ƒå‡½æ•°ï¼Œéœ€è¦ `pollyfill`ï¼Œè€Œä¸”æ‹¥æœ‰ `deadline` å‚æ•°ï¼Œé™åˆ¶æ‰§è¡Œäº‹ä»¶ï¼Œä»¥ç»§ç»­åˆ‡åˆ†ä»»åŠ¡
- é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡äº¤ç»™ `requestAnimationFrame` å¤„ç†

```js
// ç±»ä¼¼äºè¿™æ ·çš„æ–¹å¼
requestIdleCallback((deadline) => {
  // å½“æœ‰ç©ºé—²æ—¶é—´æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªç»„ä»¶æ¸²æŸ“
  // æŠŠä»»åŠ¡å¡åˆ°ä¸€ä¸ªä¸ªç¢ç‰‡æ—¶é—´ä¸­å»
  while ((deadline.timeRemaning() > 0 || deadline.didTimeout) && nextComponent) {
    nextComponent = performWork(nextComponent);
  }
});
```

> ç”±äº `reconciliation` é˜¶æ®µæ˜¯å¯ä¸­æ–­çš„ï¼Œä¸€æ—¦ä¸­æ–­ä¹‹åæ¢å¤çš„æ—¶å€™åˆä¼šé‡æ–°æ‰§è¡Œï¼Œæ‰€ä»¥å¾ˆå¯èƒ½ `reconciliation` é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨ `reconciliation` é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•æ˜¯ä¸ç¨³å®šçš„ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯ React ä¸ºä»€ä¹ˆè¦åºŸå¼ƒ `componentWillMount` å’Œ `componentWillReceiveProps` æ–¹æ³•è€Œæ”¹ä¸ºé™æ€æ–¹æ³• `getDerivedStateFromProps` çš„åŸå› å§ã€‚

### requestIdleCallback

`requestIdleCallback` çš„å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š

```js
window.requestIdleCallback(callback[, options])
// ç¤ºä¾‹
let handle = window.requestIdleCallback((deadline) => {
    // didTimeout æ˜¯å¦è¶…æ—¶
    // timeRemaining å‰©ä½™å¯ç”¨æ—¶é—´
    const {didTimeout, timeRemaining} = deadline;

    console.log(`æ˜¯å¦å·²è¶…æ—¶ï¼š${didTimeout}`);
    console.log(`å‰©ä½™å¯ç”¨å¯ç”¨æ—¶é—´ï¼š${timeRemaining.call(deadline)}ms`);

    // do some stuff
    const now = +new Date,
          timespent = 10;
    while (+new Date < now + timespent);
    console.log(`èŠ±äº†${timespent}msæäº‹æƒ…`);
    console.log(`å¯ç”¨æ—¶é—´å‰©ä½™${timeRemaining.call(deadline)}ms`);
  },{
    timeout: 1000
  }
);
// Outputï¼š
// æ˜¯å¦å·²è¶…æ—¶ï¼šfalse
// å‰©ä½™å¯ç”¨å¯ç”¨æ—¶é—´ï¼š49.535000000000004ms
// èŠ±äº†10msæäº‹æƒ…
// å¯ç”¨æ—¶é—´å‰©ä½™38.64ms
```

âš ï¸ **æ³¨æ„**ï¼š`requestIdleCallback` è°ƒåº¦åªæ˜¯å¸Œæœ›åšåˆ°æµç•…ä½“éªŒï¼Œå¹¶ä¸èƒ½ç»å¯¹ä¿è¯ä»€ä¹ˆï¼Œä¾‹å¦‚ï¼š

```js
// do some stuff
const now = +new Date(),
  timespent = 300;

while (+new Date() < now + timespent);
```

å¦‚æœæäº‹æƒ…ï¼ˆå¯¹åº” React ä¸­çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç­‰æ—¶é—´ä¸Šä¸å— React æ§åˆ¶çš„ä¸œè¥¿ï¼‰å°±èŠ±äº† 300msï¼Œä»€ä¹ˆæœºåˆ¶ä¹Ÿä¿è¯ä¸äº†æµç•…ã€‚

> âš ï¸ **æ³¨æ„**ï¼šä¸€èˆ¬å‰©ä½™å¯ç”¨æ—¶é—´ä¹Ÿå°± 10-50msï¼Œå¯è°ƒåº¦ç©ºé—´ä¸ç®—å¾ˆå®½è£•ã€‚

è¿™ä¸ªå‡½æ•°çš„å…¼å®¹æ€§å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¹¶ä¸”å®ƒè¿˜æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ï¼š

> requestIdleCallback is called only 20 times per second - Chrome on my 6x2 core Linux machine, it's not really useful for UI work.

ä¹Ÿå°±æ˜¯è¯´ requestIdleCallback åªèƒ½ä¸€ç§’è°ƒç”¨å›è°ƒ 20 æ¬¡ï¼Œè¿™ä¸ªå®Œå…¨æ»¡è¶³ä¸äº†ç°æœ‰çš„æƒ…å†µã€‚

æ—©æœŸçš„ React ç‰ˆæœ¬åœ¨å®ç°ä¸Šä½¿ç”¨çš„æ˜¯ `requestIdleCallback` APIï¼Œä½†ä½¿ç”¨ `requestIdleCallback` å®é™…ä¸Šæœ‰ä¸€äº›é™åˆ¶ï¼Œæ‰§è¡Œé¢‘æ¬¡ä¸è¶³ï¼Œä»¥è‡´äºæ— æ³•å®ç°æµç•…çš„ UI æ¸²æŸ“ï¼Œæ‰©å±•æ€§å·®ã€‚å› æ­¤ React å›¢é˜Ÿæ”¾å¼ƒäº† `requestIdleCallback` ç”¨æ³•ï¼Œå®ç°äº†è‡ªå®šä¹‰çš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ï¼Œåœ¨å‘å¸ƒ v16.10 ç‰ˆæœ¬ä¸­ï¼Œæ¨å‡ºå®éªŒæ€§çš„ Schedulerï¼Œå°è¯•ä½¿ç”¨ MessageChannel API å’Œ `requestAnimationFrame` å®ç° `requestIdleCallback`ã€‚æ›´å¤šäº†è§£å¯ä»¥æŸ¥çœ‹ React æºç  `packages/scheduler` éƒ¨åˆ†ã€‚

- æ‰€ä»¥ç›®å‰ React åˆ©ç”¨ MessageChannel æ¨¡æ‹Ÿäº† `requestIdleCallback`ï¼Œå°†å›è°ƒå»¶è¿Ÿåˆ°ç»˜åˆ¶æ“ä½œä¹‹åæ‰§è¡Œ
- MessageChannel API å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ª MessagePort å±æ€§å‘é€æ•°æ®
- MessageChannel åˆ›å»ºäº†ä¸€ä¸ªé€šä¿¡çš„ç®¡é“ï¼Œè¿™ä¸ªç®¡é“æœ‰ä¸¤ä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£éƒ½å¯ä»¥é€šè¿‡ `postMessage` å‘é€æ•°æ®ï¼Œè€Œä¸€ä¸ªç«¯å£åªè¦ç»‘å®šäº† `onmessage` å›è°ƒæ–¹æ³•ï¼Œå°±å¯ä»¥æ¥æ”¶ä»å¦ä¸€ä¸ªç«¯å£ä¼ æ¥çš„æ•°æ®
- MessageChannel æ˜¯ä¸€ä¸ªå®ä»»åŠ¡

å®é™…ä½¿ç”¨ MessageChannel API æ¨¡æ‹Ÿå®ç°ï¼š

```js
let channel = new MessageChannel();
let activeFrameTime = 1000 / 60; // 16.6
let frameDeadLine; // è¿™ä¸€å¸§çš„æˆªæ­¢æ—¶é—´
let pendingCallback;
let timeRemaining = () => frameDeadLine - performance.now();

channel.port2.onmessage = function () {
  let currentTime = performance.now();
  // å¦‚æœå¸§çš„æˆªæ­¢æ—¶é—´å·²ç»å°äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å·²ç»è¿‡æœŸäº†
  let didTimeout = frameDeadLine <= currentTime;
  if (didTimeout || timeRemaining() > 0) {
    if (pendingCallback) {
      pendingCallback({ didTimeout, timeRemaining });
    }
  }
};

window.requestIdleCallback = (callback, options) => {
  requestAnimationFrame((rafTime) => {
    console.log('rafTime', rafTime);
    // æ¯å¸§å¼€å§‹æ—¶é—´åŠ ä¸Š 16.6 å°±æ˜¯è¿™ä¸€å¸§çš„æˆªæ­¢æ—¶é—´
    frameDeadLine = rafTime + activeFrameTime;
    pendingCallback = callback;
    // å…¶å®å‘æ¶ˆæ¯ä¹‹åï¼Œç›¸å½“äºæ·»åŠ äº†ä¸€ä¸ªå®ä»»åŠ¡
    channel.port1.postMessage('Hello');
  });
};
```

### Reconciler - commit é˜¶æ®µ

Commit é˜¶æ®µå¯ä»¥ç†è§£ä¸ºå°±æ˜¯å°† Diff çš„ç»“æœåæ˜ åˆ°çœŸå® DOM çš„è¿‡ç¨‹ã€‚

åœ¨ Commit é˜¶æ®µï¼Œé¦–å…ˆä¼šåœ¨ `commitRoot` é‡Œä¼šæ ¹æ® `effect` çš„ `effectTag`ï¼Œå…·ä½“ `effectTag` è§ [æºç ](https://github.com/facebook/react/blob/504576306461a5ff339dc99691842f0f35a8bf4c/packages/shared/ReactSideEffectTags.js)ï¼Œè¿›è¡Œå¯¹åº”çš„æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œæ ¹æ® `tag` ä¸åŒï¼Œè°ƒç”¨ä¸åŒçš„æ›´æ–°æ–¹æ³•ã€‚

Commit é˜¶æ®µä¼šæ‰§è¡Œå¦‚ä¸‹ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

- `getSnapshotBeforeUpdate`
- `componentDidMount`
- `componentDidUpdate`
- `componentWillUnmount`

æ³¨æ„ï¼ŒCommit é˜¶æ®µçœŸçš„æ˜¯ä¸€æ°”å‘µæˆï¼ˆåŒæ­¥æ‰§è¡Œï¼Œæ— æ³•æš‚åœï¼‰ï¼Œè¿™ä¸ªé˜¶æ®µçš„å®é™…å·¥ä½œé‡æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦åœ¨åä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œå¤„ç†å¤æ‚çš„é€»è¾‘è®¡ç®—ã€‚

> å¤„ç† Effect List ä¸‰éƒ¨æ›²ï¼šæ›´æ–° DOM æ ‘ã€è°ƒç”¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä»¥åŠæ›´æ–° `ref` ç­‰å†…éƒ¨çŠ¶æ€
>
> æ³¨æ„åŒºåˆ« `reconciler`ã€`reconcile` å’Œ `reconciliation`ï¼š
>
> - `reconciler`ï¼šè°ƒå’Œå™¨ï¼ˆåè¯ï¼‰ï¼Œå¯ä»¥è¯´æ˜¯ React å·¥ä½œçš„ä¸€ä¸ªæ¨¡å—ï¼Œåè°ƒæ¨¡å—
> - `reconcile`ï¼šè°ƒå’Œå™¨è°ƒå’Œçš„åŠ¨ä½œï¼ˆåŠ¨è¯ï¼‰
> - `reconciliation`ï¼šåªæ˜¯ `reconcile` è¿‡ç¨‹çš„ç¬¬ä¸€é˜¶æ®µ

### ä¼˜å…ˆçº§ç­–ç•¥

æ¯ä¸ªå·¥ä½œå•å…ƒè¿è¡Œæ—¶æœ‰å…­ç§ä¼˜å…ˆçº§ï¼š

- `no work`ï¼šæ²¡æœ‰å·¥ä½œä»»åŠ¡åœ¨ Pending
- `synchronous`ï¼ˆ1ï¼‰ï¼šä¸ä¹‹å‰çš„ Stack Reconciler æ“ä½œä¸€æ ·ï¼ŒåŒæ­¥æ‰§è¡Œ
- `task`ï¼ˆ2ï¼‰ï¼šåœ¨ `nextTick` ä¹‹å‰æ‰§è¡Œ
- `animation`ï¼ˆ3ï¼‰ï¼šåœ¨ä¸‹ä¸€å¸§ä¹‹å‰æ‰§è¡Œ
- `high`ï¼ˆ4ï¼‰ï¼šéœ€è¦å¾ˆå¿«å®Œæˆçš„äº’åŠ¨æ‰èƒ½æ„Ÿè§‰åˆ°å“åº”
- `low`ï¼ˆ5ï¼‰ï¼šç¨å¾®å»¶è¿Ÿï¼ˆ100-200msï¼‰æ‰§è¡Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ•°æ®è·å–æˆ–æ›´æ–°å­˜å‚¨çš„ç»“æœ
- `offscreen`ï¼ˆ6ï¼‰ï¼šä¸ä¼šè¢«çœ‹åˆ°ï¼Œä½†è¦åšå¥½å·¥ä½œä»¥é˜²å®ƒå˜å¾—å¯è§

ä¼˜å…ˆçº§è¯´æ˜ï¼š

- `synchronous` é¦–å±ï¼ˆé¦–æ¬¡æ¸²æŸ“ï¼‰ç”¨ï¼Œè¦æ±‚å°½é‡å¿«ï¼Œä¸ç®¡ä¼šä¸ä¼šé˜»å¡ UI çº¿ç¨‹ï¼›
- `animation` é€šè¿‡ `requestAnimationFrame` æ¥è°ƒåº¦ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€å¸§å°±èƒ½ç«‹å³å¼€å§‹åŠ¨ç”»è¿‡ç¨‹ï¼›
- åä¸‰ä¸ªéƒ½æ˜¯ç”± `requestIdleCallback` å›è°ƒæ‰§è¡Œçš„ï¼›
- `offscreen` æŒ‡çš„æ˜¯å½“å‰éšè—çš„ã€å±å¹•å¤–çš„ï¼ˆçœ‹ä¸è§çš„ï¼‰å…ƒç´ ã€‚

é«˜ä¼˜å…ˆçº§çš„æ¯”å¦‚é”®ç›˜è¾“å…¥ï¼ˆå¸Œæœ›ç«‹å³å¾—åˆ°åé¦ˆï¼‰ï¼Œä½ä¼˜å…ˆçº§çš„æ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼Œè®©è¯„è®ºæ˜¾ç¤ºå‡ºæ¥ç­‰ç­‰ã€‚å¦å¤–ï¼Œç´§æ€¥çš„äº‹å…è®¸æ’é˜Ÿã€‚

è¿™æ ·çš„ä¼˜å…ˆçº§æœºåˆ¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

- ç”Ÿå‘½å‘¨æœŸå‡½æ•°æ€ä¹ˆæ‰§è¡Œï¼ˆå¯èƒ½è¢«é¢‘é¢‘ä¸­æ–­ï¼‰ï¼šè§¦å‘é¡ºåºã€æ¬¡æ•°æ²¡æœ‰ä¿è¯äº†
- `starvation`ï¼ˆä½ä¼˜å…ˆçº§é¥¿æ­»ï¼‰ï¼šå¦‚æœé«˜ä¼˜å…ˆçº§ä»»åŠ¡å¾ˆå¤šï¼Œé‚£ä¹ˆä½ä¼˜å…ˆçº§ä»»åŠ¡æ ¹æœ¬æ²¡æœ‰æœºä¼šæ‰§è¡Œï¼ˆå°±é¥¿æ­»äº†ï¼‰

**ç®€æ˜çš„ä¼˜å…ˆçº§ç­–ç•¥**ï¼š`æ–‡æœ¬æ¡†è¾“å…¥ > æœ¬æ¬¡è°ƒåº¦ç»“æŸéœ€è¦å®Œæˆçš„ä»»åŠ¡ > åŠ¨ç”»è¿‡æ¸¡ > äº¤äº’åé¦ˆ > æ•°æ®æ›´æ–° > ä¸ä¼šæ˜¾ç¤ºä½†ä»¥é˜²å°†æ¥ä¼šæ˜¾ç¤ºçš„ä»»åŠ¡`

> âš ï¸ **æ³¨æ„**ï¼šReact 17 å…¨é¢å¼€å¯ `async rendering`ã€‚å› æ­¤ 17 å°†ä¼šåºŸå¼ƒå¤šä¸ªç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼ˆ`will` ç³»åˆ—ï¼‰ï¼ŒåŸå› æ˜¯å¼€å¯ `async rendering`ï¼Œåœ¨ `render` å‡½æ•°ä¹‹å‰çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½æœ‰å¯èƒ½è¢«æ‰§è¡Œå¤šæ¬¡ã€‚
>
> é•¿æœŸä»¥æ¥ï¼ŒåŸæœ‰çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°æ€»æ˜¯ä¼šè¯±æƒ‘å¼€å‘è€…åœ¨ `render` ä¹‹å‰çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°åšä¸€äº›åŠ¨ä½œï¼Œç°åœ¨è¿™äº›åŠ¨ä½œè¿˜æ”¾åœ¨è¿™äº›å‡½æ•°ä¸­çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œè¿™è‚¯å®šä¸æ˜¯ä½ æƒ³è¦çš„ç»“æœã€‚åœ¨ `componentWillMount` æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œæ— è®ºè¯·æ±‚å¤šå¿«éƒ½æ— æ³•èµ¶ä¸Šé¦–æ¬¡ `render`ï¼Œè€Œä¸” `componentWillMount` åœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œè¿™æ ·çš„ I/O æ“ä½œæ”¾åœ¨ `componentDidMount` é‡Œæ›´åŠ åˆé€‚ã€‚
>
> åœ¨ Fiber å¯ç”¨ `async rendering` ä¹‹åï¼Œæ›´æ²¡æœ‰ç†ç”±åœ¨ `componentWillMount` é‡Œæ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œå› ä¸º `componentWillMount` å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œè°ä¹Ÿä¸ä¼šå¸Œæœ›æ— è°“åœ°å¤šæ¬¡è°ƒç”¨å¤šæ¬¡ç½‘ç»œè¯·æ±‚å§ã€‚

## æºç ç®€æ

ä» 15 åˆ° 16ï¼Œæºç ç»“æ„å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼š

- å†ä¹Ÿçœ‹ä¸åˆ° `mountComponent/updateComponent()` äº†ï¼Œè¢«æ‹†åˆ†é‡ç»„æˆäº†ï¼ˆ`beginWork`ã€`completeWork`ã€`commitWork`ï¼‰
- `ReactDOMComponent` ä¹Ÿè¢«å»æ‰äº†ï¼Œåœ¨ Fiber ä½“ç³»ä¸‹ DOM èŠ‚ç‚¹æŠ½è±¡ç”¨ `ReactDOMFiberComponent` è¡¨ç¤ºï¼Œç»„ä»¶ç”¨ `ReactFiberClassComponent` è¡¨ç¤ºï¼Œä¹‹å‰æ˜¯ `ReactCompositeComponent`

Fiber ä½“ç³»çš„æ ¸å¿ƒæœºåˆ¶æ˜¯è´Ÿè´£ä»»åŠ¡è°ƒåº¦çš„ `ReactFiberScheduler`ï¼Œç›¸å½“äºä¹‹å‰çš„ `ReactReconciler`ã€‚

VirtualDOM Tree å˜æˆ Fiber T ree äº†ï¼Œä»¥å‰æ˜¯è‡ªä¸Šè€Œä¸‹çš„ç®€å•æ ‘ç»“æ„ï¼Œç°åœ¨æ˜¯åŸºäºå•é“¾è¡¨çš„æ ‘ç»“æ„ï¼Œç»´æŠ¤çš„èŠ‚ç‚¹å…³ç³»æ›´å¤šä¸€äº›ã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/fiber-tree.png';

export default () => <img alt="Fiber Tree" src={img} width={540} />;
```

## æ€»ç»“

React Fiber æ˜¯å¯¹ React æ¥è¯´æ˜¯ä¸€æ¬¡é©å‘½ï¼Œè§£å†³äº† React é¡¹ç›® **ä¸¥é‡ä¾èµ–äºæ‰‹å·¥ä¼˜åŒ–** çš„ç—›ç‚¹ï¼Œé€šè¿‡ç³»ç»Ÿçº§åˆ«çš„æ—¶é—´è°ƒåº¦ï¼Œå®ç°åˆ’æ—¶ä»£çš„æ€§èƒ½ä¼˜åŒ–ã€‚é¬¼æ‰èˆ¬çš„ Fiber ç»“æ„ï¼Œä¸ºå¼‚å¸¸è¾¹ç•Œæä¾›äº†é€€è·¯ï¼Œä¹Ÿä¸ºé™é‡æ›´æ–°æä¾›äº†ä¸‹ä¸€ä¸ªèµ·ç‚¹ã€‚

React Fiber æœ€ç»ˆæä¾›çš„å…³é”®ç‰¹æ€§ä¸»è¦æ˜¯ï¼š

- å¢é‡æ¸²æŸ“ï¼ˆæŠŠæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†æˆå—ï¼Œå‡åŒ€åˆ†å¸ƒåˆ°å¤šå¸§ï¼‰
- æ›´æ–°æ—¶èƒ½å¤Ÿæš‚åœã€ç»ˆæ­¢ã€å¤ç”¨æ¸²æŸ“ä»»åŠ¡
- ç»™ä¸åŒç±»å‹çš„æ›´æ–°èµ‹äºˆä¼˜å…ˆçº§
- å¹¶å‘æ–¹é¢æ–°çš„åŸºç¡€èƒ½åŠ›

å¢é‡æ¸²æŸ“ç”¨æ¥è§£å†³æ‰å¸§çš„é—®é¢˜ï¼Œæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†ä¹‹åï¼Œæ¯æ¬¡åªåšä¸€å°æ®µï¼Œåšå®Œä¸€æ®µå°±æŠŠæ—¶é—´æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»çº¿ç¨‹ï¼Œè€Œä¸åƒä¹‹å‰é•¿æ—¶é—´å ç”¨ã€‚è¿™ç§ç­–ç•¥å«åš `cooperative scheduling`ï¼ˆåˆä½œå¼è°ƒåº¦ï¼‰ï¼Œæ“ä½œç³»ç»Ÿçš„ 3 ç§ä»»åŠ¡è°ƒåº¦ç­–ç•¥ä¹‹ä¸€ï¼ˆFirefox è¿˜å¯¹çœŸå® DOM åº”ç”¨äº†è¿™é¡¹æŠ€æœ¯ï¼‰ã€‚

å¦å¤–ï¼ŒReact è‡ªèº«çš„ `killer feature` æ˜¯ Virtual DOMï¼Œä¸¤ä¸ªåŸå› ï¼š

- Coding UI å˜ç®€å•äº†ï¼ˆä¸ç”¨å…³å¿ƒæµè§ˆå™¨åº”è¯¥æ€ä¹ˆåšï¼Œè€Œæ˜¯æŠŠä¸‹ä¸€åˆ»çš„ UI æè¿°ç»™ React å¬ï¼‰
- æ—¢ç„¶ DOM èƒ½ Virtuedï¼Œåˆ«çš„ï¼ˆç¡¬ä»¶ã€VRã€Native APPï¼‰ä¹Ÿèƒ½

---

**å‚è€ƒèµ„æ–™ï¼š**

- **ä¼˜å…ˆæ¨è**
  - [ğŸ“ Deep In React ä¹‹æµ…è°ˆ React Fiber æ¶æ„](https://segmentfault.com/a/1190000019592928)
  - [ğŸ“ æµ…è°ˆ React 16 æ¡†æ¶æ¶æ„ Fiberï¼ˆ2018-08-29 æ¨èï¼‰](https://mp.weixin.qq.com/s?__biz=MzU0OTExNzYwNg==&mid=2247484359&idx=1&sn=442d4a8c5027b58b3decfa3882b87a85&chksm=fbb5880eccc20118186380d943f0f58000e3e8946405f83e70bc43fe9f7323dee6725e1a47ab&token=1033099811&lang=zh_CN&rd2werd=1#wechat_redirect)
  - [ğŸ“ React Fiber é‚£äº›äº‹ï¼šæ·±å…¥è§£ææ–°çš„åè°ƒç®—æ³•ï¼ˆ2018-12-03 æ¨èï¼‰](https://juejin.im/post/5c052f95e51d4523d51c8300)
  - [ğŸ“ React Fiber æºç è§£æï¼ˆ2020-08-11 æ¨èï¼‰](https://juejin.im/post/6859528127010471949)
  - [ğŸ“ è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber æ‰“å¼€æ–¹å¼ï¼ˆ2019-10-22 æ¨èï¼‰](https://juejin.im/post/6844903975112671239)
  - [ğŸ“ å‰–æ React æºç ï¼šè°ƒåº¦åŸç†](https://github.com/KieSun/Dream/issues/21)
- **ä¼˜è´¨å¥½æ–‡**
  - [ğŸ“ React Fiber åˆæ¢ï¼ˆ2017-12-02ï¼‰](https://juejin.im/post/6844903518357159949)
  - [ğŸ“ å®Œå…¨ç†è§£ React Fiberï¼ˆ2018-01-06ï¼‰](http://www.ayqy.net/blog/dive-into-react-fiber/)
  - [ğŸ“ React Fiber åˆæ¢ï¼ˆ2018-06-19ï¼‰](https://mp.weixin.qq.com/s/uDIknJ-WeUJnPR8S-HnTww)
  - [ğŸ“ React Fiber æ¶æ„ï¼ˆ2018-05-21ï¼‰](https://zhuanlan.zhihu.com/p/37095662)
  - [ğŸ“ React16 æºç ä¹‹ React Fiber æ¶æ„](https://juejin.im/post/6844903655401848846)
  - [ğŸ“ React é‡è¦çš„ä¸€æ¬¡é‡æ„ï¼šè®¤è¯†å¼‚æ­¥æ¸²æŸ“æ¶æ„ Fiberï¼ˆ2018-11-15ï¼‰](https://juejin.im/post/5bed21546fb9a049e93c4bac)
  - [ğŸ“ React Fiber åœ¨å¹¶å‘æ¨¡å¼ä¸‹çš„è¿è¡Œæœºåˆ¶ï¼ˆ2019-01-05ï¼‰](https://zhuanlan.zhihu.com/p/54042084)
  - [ğŸ“ å¦‚ä½•åŠä¸ºä»€ä¹ˆ React Fiber ä½¿ç”¨é“¾è¡¨éå†ç»„ä»¶æ ‘ï¼ˆ2019-01-07ï¼‰](https://mp.weixin.qq.com/s/Zko4ih2F0-_861cDy1-1hw)
  - [ğŸ“ æ·±å…¥ React Fiber æ¶æ„åŠæºç ï¼ˆ2019-03-09ï¼‰](https://zhuanlan.zhihu.com/p/57346388)
  - [ğŸ“ React Fiber çš„ä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶ä¸äº‹ä»¶ç³»ç»Ÿ](https://zhuanlan.zhihu.com/p/95443185)
- **React Fiber æºç åˆ†æç³»åˆ—**
  - [ç¬¬ä¸€ç¯‡](https://juejin.im/post/5c4edbede51d453aec64531c)
  - [ç¬¬äºŒç¯‡ï¼šåŒæ­¥æ¨¡å¼](https://juejin.im/post/5c501613f265da611e4e07a8)
  - [ç¬¬ä¸‰ç¯‡ï¼šå¼‚æ­¥çŠ¶æ€](https://juejin.im/post/5c515e58e51d45593c376bb4)
  - [ç¬¬å››ç¯‡ï¼šå½’çº³æ€»ç»“](https://juejin.im/post/5c529aba518825261f7386f6)
